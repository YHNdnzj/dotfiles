#!/bin/bash

select_card() {
    for card in /dev/dri/card*; do
        if (( $(udevadm info -an "$card" | grep boot_vga | rev | cut -c 2) )); then
            export WLR_DRM_DEVICES="$card"
            break
        fi
    done

    if [[ ! $WLR_DRM_DEVICES ]]; then
        echo "No available GPU found!" >&2
        exit 1
    fi
}

if [[ ! $WLR_DRM_DEVICES ]]; then
    select_card
fi

if [[ ! $SWAY_CONF_SELECTED ]]; then
    export SWAY_CONF_SELECTED="$(find "$HOME/.config/sway/" -maxdepth 1 -name "config*" ! -name "config.common" -print0 | fzf --read0)"
    if [[ ! $SWAY_CONF_SELECTED ]]; then
        echo "No configuration file selected!" >&2
        exit 2
    fi
fi

if [[ -t 1 ]]; then
    exec systemd-cat --identifier=sway "$0"
else
    unset JOURNAL_STREAM
fi

set -ex
envfiles=("$HOME/.config/sway/env"/*)
for envfile in "${envfiles[@]}"; do
    source "$envfile"
done
set +x

cd "$HOME"
export -n OLDPWD SWAY_CONF_SELECTED
exec /usr/bin/sway --unsupported-gpu --config "$SWAY_CONF_SELECTED"
