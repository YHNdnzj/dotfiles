#!/bin/bash -e

if (( EUID != 0 )); then
    exec sudo --preserve-env=HOME "$0" "$@"
fi

if (( $# == 2 )); then
    SOURCE=$1 DEST=$2 RUN=("--dry-run" "--itemize-changes" "--verbose")
    dry_run=1
elif (( $# == 3 )); then
    SOURCE=$2 DEST=$3
    if [[ $1 == "--run" ]]; then
        RUN=("--info=progress2")
        dry_run=0
    fi
fi

if ! [[ -d $SOURCE && -d $DEST ]] || [[ ! $dry_run ]]; then
    echo "usage: ${0##*/} [--run] SOURCE DEST" >&2
    exit 1
fi

DESTFILE="$DEST/.sysbackup_dest"
if [[ ! -f "$DESTFILE" ]]; then
    echo "Please create \`$DESTFILE' before first run."
    echo "This helps to prevent accidental overwrites."
    exit 2
fi

set -ux

rsync "${RUN[@]}" \
    --archive --acls --xattrs --hard-links --sparse \
    --numeric-ids --inplace \
    --atimes --open-noatime \
    --one-file-system \
    --exclude-from="$HOME/.sysbackup/rootfs.exclude" --exclude-from="$HOME/.sysbackup/home.exclude" \
    --delete --delete-excluded \
    "$SOURCE/" "$DEST"

if mountpoint -q --nofollow "$SOURCE/efi"; then
    rsync "${RUN[@]}" \
        --archive --inplace \
        --atimes --open-noatime \
        --one-file-system \
        --exclude loader/random-seed \
        --delete --delete-excluded \
        "$SOURCE/efi/" "$DEST/efi"
fi

if ! (( dry_run )); then
    touch "$DESTFILE"
fi
