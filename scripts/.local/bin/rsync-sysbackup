#!/bin/bash -e

if [[ $# == 2 ]]; then
    SOURCE=$1 DEST=$2 RUN="--dry-run"
    run_valid=1
elif [[ $# == 3 ]]; then
    SOURCE=$2 DEST=$3
    if [[ $1 == "--run" ]]; then
        RUN=""
        run_valid=1
    else
        run_valid=0
    fi
fi

if ! [[ -d $SOURCE && -d $DEST ]] || ! (( run_valid )); then
    echo "usage: ${0##*/} [--run] SOURCE DEST" >&2
    exit 1
fi

set -ux

sudo rsync "$RUN" \
    --archive --acls --xattrs --hard-links --sparse \
    --atimes --crtimes \
    --numeric-ids --inplace \
    --one-file-system \
    --exclude-from="$HOME/.sysbackup/rootfs.exclude" --exclude-from="$HOME/.sysbackup/home.exclude" \
    --delete --delete-excluded \
    --info=progress2 --itemize-changes \
    "$SOURCE" "$DEST"

if [[ -d $SOURCE/efi ]]; then
    sudo rsync "$RUN" \
        --atimes --crtimes \
        --one-file-system \
        --exclude loader/random-seed \
        --delete --delete-excluded \
        --info=progress2 --itemize-changes \
        "$SOURCE/efi" "$DEST/efi"
fi
